## Preprocessing
These are the code for data preprocessing.

### Dependancy
The code depends on Tensorflow (for PointCNN feature extraction), Pytorch 2 (for obb computation) and Pytorch 3 (for others). [open3d][3], [sklearn][4], [matlab.engine][5] should also be installed under Python3. 

### Data download
For quick start, you can simply download the processed data of Matterport and S3DIS scenes [here](?).
You can also download the raw data of Matterport and S3DIS scenes [here](?).

### Usage
The function of this code is to load an oversegemented scene, compute the pair-wise affinities for the oversegemented patches, build hierarchy by normalized-cut, extract features for each node and generate pickle files that could be processed by VDRAE. An example about how to run the code is bat_preprocess.py. You can simply modify the varibles (dataset and data_path) to run the script.

### Data format
Input data:
- DATASET/SCENE/scene_normal.txt: the point cloud of the scene. Each line includes the information of a point (x, y, z, r, g, b, nx, ny, nz).
- DATASET/SCENE/overseg.txt: oversegementation of the scene. Each line stores the oversegmentation label of the corresponding point in scene_normal.txt. We recommend to use the oversegmentation code at: .
- DATASET/SCENE/gt_info.txt: the groud truth object instances of the scene. Each line stores the aabb (6 float number), obb (8 float number), semantic segmenation category (1 int number) and other information (1 string).

Data generated by the code:
- DATASET/SCENE/data/leaf_pts: folder to store the data of oversegmented patches
- DATASET/SCENE/data/merge_leaf_pts: folder to store the data of merged patches. These patches are the leaf node of the hierarchy.
- DATASET/SCENE/data/internal_pts: folder to store the data of internal nodes.
- DATASET/SCENE/data/files/hier_ncut.txt: the generated hierarchy by normalized-cut.
- DATASET/SCENE/data/files/segment_adjacent_matrix.txt: adjacent matrix of the merged patches.
- DATASET/SCENE/data/files/segment_affinity_matrix.txt: affinity matrix of the merged patches.
- processed_data/*.pkl: processed data of the input scene.

### PointCNN
We provide some details about the PoinCNN code.
- Training: 
~~~~ 
python3 train_val_cls.py -t TRAINING_TXT_FILE -s PATH_OF_POINTCNN_CODE -m pointcnn_cls -x example_x3_l4 --gpu GPU
~~~~ 

- Feature extraction: 
~~~~ 
python3 gen_node_prob_feature.py -t INFERENCE_TXT_FILE -s PATH_OF_POINTCNN_CODE -m pointcnn_cls -x example_x3_l4 -l PRETRAEINED_MODEL_PATH --gpu GPU
~~~~ 

[1]:  https://arxiv.org/pdf/1903.03757.pdf "Hierarchy Denoising Recursive Autoencoders for 3D Scene Layout Prediction"
[2]:  https://github.com/nearai/torchfold "Data and model"
[3]:  http://www.open3d.org/ "open3d"
[4]:  https://scikit-learn.org/stable/ "sklearn"
[5]:  https://www.mathworks.com/help/matlab/matlab_external/install-the-matlab-engine-for-python.html "matlab.engine"
